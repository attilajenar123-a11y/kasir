/* Kasir Offline + Game "SAYANG"
   - Data tersimpan lokal (localStorage)
   - Tab navigation kebal (event delegation)
   - Kasir: produk, edit harga, cart, checkout
   - Riwayat: list transaksi + modal detail + export JSON
   - Game: meter suara (dB), deteksi kata SAYANG (kalau browser support), manual button fallback
*/

(() => {
  // -----------------------------
  // Utils
  // -----------------------------
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const fmtIDR = (n) => {
    const v = Number(n || 0);
    return "Rp " + v.toLocaleString("id-ID");
  };

  const nowISO = () => new Date().toISOString();
  const toLocalTime = (iso) => {
    const d = new Date(iso);
    return d.toLocaleString("id-ID", { dateStyle: "medium", timeStyle: "short" });
  };

  const uid = () => Math.random().toString(16).slice(2, 8).toUpperCase();

  const storage = {
    get(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    },
    set(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    },
    del(key) {
      localStorage.removeItem(key);
    }
  };

  // -----------------------------
  // Keys
  // -----------------------------
  const K_PRODUCTS = "kasir.products.v1";
  const K_CART = "kasir.cart.v1";
  const K_TX = "kasir.transactions.v1";
  const K_SCORES = "kasir.game.scores.v1";

  // -----------------------------
  // Elements
  // -----------------------------
  const el = {
    tabs: $(".tabs"),
    viewKasir: $("#view-kasir"),
    viewRiwayat: $("#view-riwayat"),
    viewGame: $("#view-game"),

    tabKasir: $("#tab-kasir"),
    tabRiwayat: $("#tab-riwayat"),
    tabGame: $("#tab-game"),

    search: $("#search"),
    btnReset: $("#btn-reset"),
    products: $("#products"),

    sumItems: $("#sum-items"),
    sumTotal: $("#sum-total"),
    btnCheckout: $("#btn-checkout"),

    btnExport: $("#btn-export"),
    txEmpty: $("#tx-empty"),
    transactions: $("#transactions"),

    modal: $("#modal"),
    modalCloseBackdrop: $("#modal-close"),
    modalX: $("#modal-x"),
    modalSub: $("#modal-sub"),
    modalBody: $("#modal-body"),
    modalTitle: $("#modal-title"),

    toast: $("#toast"),

    // Game
    btnGameReset: $("#btn-game-reset"),
    bt
